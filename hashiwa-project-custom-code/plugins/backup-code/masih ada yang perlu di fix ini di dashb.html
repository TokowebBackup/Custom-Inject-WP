masih ada yang perlu di fix ini di dashboard courses nya di bagian sidebar collapsible list topic, misal jika ada di
topic pertama :
https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/testing-one-lesson-first/

<div class="tutor-course-single-sidebar-wrapper tutor-lesson-sidebar" bis_skin_checked="1">

    <div class="tutor-course-single-sidebar-title tutor-d-flex tutor-justify-between" bis_skin_checked="1">
        <span class="tutor-fs-6 tutor-fw-medium tutor-color-secondary">Course Content</span>
        <span class="tutor-d-block tutor-d-xl-none">
            <a href="#" class="tutor-iconic-btn" tutor-hide-course-single-sidebar="">
                <span class="tutor-icon-times"></span>
            </a>
        </span>
    </div>

    <div class="tutor-course-topic tutor-course-topic-17014" data-rendered="1" bis_skin_checked="1">
        <div class="tutor-accordion-item-header is-active" style="opacity: 1; pointer-events: auto;"
            bis_skin_checked="1">
            <div class="tutor-row tutor-gx-1" bis_skin_checked="1">
                <div class="tutor-col" bis_skin_checked="1">
                    <div class="tutor-course-topic-title" bis_skin_checked="1">
                        Topic Bab 1 <div class="tutor-course-topic-title-info tutor-ml-8" bis_skin_checked="1">
                            <div class="tooltip-wrap" bis_skin_checked="1">
                                <i class="tutor-course-topic-title-info-icon tutor-icon-circle-info-o"></i>
                                <span class="tooltip-txt tooltip-bottom">
                                    lorem ipsum dulu </span>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="tutor-col-auto tutor-align-self-center"
                    style="display: flex; align-items: center; gap: 6px;" bis_skin_checked="1"><span
                        style="background: rgb(212, 237, 218); color: rgb(21, 87, 36); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">‚úÖ
                        Order: Completed</span></div>
            </div>
        </div>

        <div class="tutor-accordion-item-body " bis_skin_checked="1">

            <div class="tutor-course-topic-item tutor-course-topic-item-lesson is-active" bis_skin_checked="1">
                <a href="https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/testing-one-lesson-first/"
                    data-lesson-id="17015">
                    <div class="tutor-d-flex tutor-mr-32" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-icon tutor-icon-brand-youtube-bold tutor-mr-8 tutor-mt-2"></span>
                        <span class="tutor-course-topic-item-title tutor-fs-7 tutor-fw-medium">
                            Testing one lesson first </span>
                    </div>

                    <div class="tutor-d-flex tutor-ml-auto tutor-flex-shrink-0" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-duration tutor-fs-7 tutor-fw-medium tutor-color-muted tutor-mr-8">01:05</span><input
                            checked="" type="checkbox" class="tutor-form-check-input tutor-form-check-circle"
                            disabled="" readonly="">
                    </div>
                </a>
            </div>
        </div>
    </div>
    <div class="tutor-course-topic tutor-course-topic-17025" data-rendered="1" bis_skin_checked="1">
        <div class="tutor-accordion-item-header is-active" style="opacity: 1; pointer-events: auto;"
            bis_skin_checked="1">
            <div class="tutor-row tutor-gx-1" bis_skin_checked="1">
                <div class="tutor-col" bis_skin_checked="1">
                    <div class="tutor-course-topic-title" bis_skin_checked="1">
                        Topic Bab 2 <div class="tutor-course-topic-title-info tutor-ml-8" bis_skin_checked="1">
                            <div class="tooltip-wrap" bis_skin_checked="1">
                                <i class="tutor-course-topic-title-info-icon tutor-icon-circle-info-o"></i>
                                <span class="tooltip-txt tooltip-bottom">
                                    lesson topic bab 2 </span>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="tutor-col-auto tutor-align-self-center"
                    style="display: flex; align-items: center; gap: 6px;" bis_skin_checked="1"><span
                        style="background: rgb(212, 237, 218); color: rgb(21, 87, 36); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">‚úÖ
                        Order: Completed</span></div>
            </div>
        </div>

        <div class="tutor-accordion-item-body tutor-display-none" bis_skin_checked="1" style="display: block;">

            <div class="tutor-course-topic-item tutor-course-topic-item-lesson" bis_skin_checked="1">
                <a href="https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/leson-di-bab-ke-2/"
                    data-lesson-id="17026">
                    <div class="tutor-d-flex tutor-mr-32" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-icon tutor-icon-brand-youtube-bold tutor-mr-8 tutor-mt-2"></span>
                        <span class="tutor-course-topic-item-title tutor-fs-7 tutor-fw-medium">
                            Leson di bab ke 2 </span>
                    </div>

                    <div class="tutor-d-flex tutor-ml-auto tutor-flex-shrink-0" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-duration tutor-fs-7 tutor-fw-medium tutor-color-muted tutor-mr-8">09:32</span><input
                            type="checkbox" class="tutor-form-check-input tutor-form-check-circle" disabled=""
                            readonly="">
                    </div>
                </a>
            </div>
        </div>
    </div>
    <div class="tutor-course-topic tutor-course-topic-17029" data-rendered="1" bis_skin_checked="1">
        <div class="tutor-accordion-item-header" bis_skin_checked="1">
            <div class="tutor-row tutor-gx-1" bis_skin_checked="1">
                <div class="tutor-col" bis_skin_checked="1">
                    <div class="tutor-course-topic-title" bis_skin_checked="1">
                        Topic Bab 3 <div class="tutor-course-topic-title-info tutor-ml-8" bis_skin_checked="1">
                            <div class="tooltip-wrap" bis_skin_checked="1">
                                <i class="tutor-course-topic-title-info-icon tutor-icon-circle-info-o"></i>
                                <span class="tooltip-txt tooltip-bottom">
                                    Topic bab 3 lorem ipsum </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tutor-col-auto tutor-align-self-center" bis_skin_checked="1">
                    <div class="tutor-course-topic-summary tutor-pl-8" bis_skin_checked="1">
                        0/1 </div>
                </div>
            </div>
        </div>

        <div class="tutor-accordion-item-body tutor-display-none" bis_skin_checked="1">

            <div class="tutor-course-topic-item tutor-course-topic-item-lesson" bis_skin_checked="1">
                <a href="https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/leson-bab-ke-3/"
                    data-lesson-id="17065">
                    <div class="tutor-d-flex tutor-mr-32" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-icon tutor-icon-brand-youtube-bold tutor-mr-8 tutor-mt-2"></span>
                        <span class="tutor-course-topic-item-title tutor-fs-7 tutor-fw-medium">
                            Leson bab ke 3 </span>
                    </div>

                    <div class="tutor-d-flex tutor-ml-auto tutor-flex-shrink-0" bis_skin_checked="1">
                        <span
                            class="tutor-course-topic-item-duration tutor-fs-7 tutor-fw-medium tutor-color-muted tutor-mr-8">14:48</span><input
                            type="checkbox" class="tutor-form-check-input tutor-form-check-circle" disabled=""
                            readonly="">
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

topic bab 3 itu harusnya locked posisinya , tapi ini malah unlocked.
tapi jika saya akses topic ke dua :
https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/leson-di-bab-ke-2/

di page topic ke 2 tersebut benar status topic ke 3 itu locked :
<div class="tutor-course-topic tutor-course-topic-17029" data-rendered="1" bis_skin_checked="1">
    <div class="tutor-accordion-item-header" style="opacity: 0.6; pointer-events: none;" bis_skin_checked="1">
        <div class="tutor-row tutor-gx-1" bis_skin_checked="1">
            <div class="tutor-col" bis_skin_checked="1">
                <div class="tutor-course-topic-title" bis_skin_checked="1">
                    Topic Bab 3 <div class="tutor-course-topic-title-info tutor-ml-8" bis_skin_checked="1">
                        <div class="tooltip-wrap" bis_skin_checked="1">
                            <i class="tutor-course-topic-title-info-icon tutor-icon-circle-info-o"></i>
                            <span class="tooltip-txt tooltip-bottom">
                                Topic bab 3 lorem ipsum </span>
                        </div>
                    </div>
                </div>
            </div>


            <div class="tutor-col-auto tutor-align-self-center" style="display: flex; align-items: center; gap: 6px;"
                bis_skin_checked="1"><span
                    style="background: rgb(255, 228, 233); color: rgb(237, 45, 86); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">üîí
                    Locked ¬∑ Rp 30.000</span></div>
        </div>
    </div>

    <div class="tutor-accordion-item-body tutor-display-none" bis_skin_checked="1">

        <div class="tutor-course-topic-item tutor-course-topic-item-lesson" bis_skin_checked="1">
            <a href="https://hashiwa.tokoweb.live/courses/course-belajar-python/lessons/leson-bab-ke-3/"
                data-lesson-id="17065">
                <div class="tutor-d-flex tutor-mr-32" bis_skin_checked="1">
                    <span
                        class="tutor-course-topic-item-icon tutor-icon-brand-youtube-bold tutor-mr-8 tutor-mt-2"></span>
                    <span class="tutor-course-topic-item-title tutor-fs-7 tutor-fw-medium">
                        Leson bab ke 3 </span>
                </div>

                <div class="tutor-d-flex tutor-ml-auto tutor-flex-shrink-0" bis_skin_checked="1">
                    <span
                        class="tutor-course-topic-item-duration tutor-fs-7 tutor-fw-medium tutor-color-muted tutor-mr-8">14:48</span><input
                        type="checkbox" class="tutor-form-check-input tutor-form-check-circle" disabled="" readonly="">
                </div>
            </a>
        </div>
    </div>
</div>

kenapa yah ???
Laptop Store 95@DESKTOP-452UK2F MINGW64
~/puji-project/Kerjaan/hashiwa-project-custom-code/plugins/tutor-paid-topic-addon-v2 (main)
$ ls -l
total 33
drwxr-xr-x 1 Laptop Store 95 197121 0 Nov 27 21:54 assets/
drwxr-xr-x 1 Laptop Store 95 197121 0 Nov 26 08:58 module/
-rw-r--r-- 1 Laptop Store 95 197121 234 Nov 25 22:47 README.md
drwxr-xr-x 1 Laptop Store 95 197121 0 Nov 27 06:12 service/
-rw-r--r-- 1 Laptop Store 95 197121 24844 Nov 27 22:38 tutor-paid-topic-addon-v2.php

Laptop Store 95@DESKTOP-452UK2F MINGW64
~/puji-project/Kerjaan/hashiwa-project-custom-code/plugins/tutor-paid-topic-addon-v2 (main)
$ ls -l module/
total 16
-rw-r--r-- 1 Laptop Store 95 197121 15643 Nov 28 11:13 frontend.php

Laptop Store 95@DESKTOP-452UK2F MINGW64
~/puji-project/Kerjaan/hashiwa-project-custom-code/plugins/tutor-paid-topic-addon-v2 (main)
$ ls -l assets/
total 36
-rw-r--r-- 1 Laptop Store 95 197121 18744 Nov 27 09:47 admin.js
-rw-r--r-- 1 Laptop Store 95 197121 4147 Nov 27 22:26 player.js
-rw-r--r-- 1 Laptop Store 95 197121 4565 Nov 28 09:03 style.css

Laptop Store 95@DESKTOP-452UK2F MINGW64
~/puji-project/Kerjaan/hashiwa-project-custom-code/plugins/tutor-paid-topic-addon-v2 (main)
$ ls -l service/
total 40
-rw-r--r-- 1 Laptop Store 95 197121 11221 Nov 27 10:05 role-registration.php
-rw-r--r-- 1 Laptop Store 95 197121 8302 Nov 27 22:51 tutor-enroll-safe.php
-rw-r--r-- 1 Laptop Store 95 197121 8427 Nov 27 22:37 tutor-enroll-unlock.php
-rw-r--r-- 1 Laptop Store 95 197121 3532 Nov 27 09:52 tutor-rest-refresh.php

Laptop Store 95@DESKTOP-452UK2F MINGW64
~/puji-project/Kerjaan/hashiwa-project-custom-code/plugins/tutor-paid-topic-addon-v2 (main)
$

patch terakhir tadi di tutor-paid-topic-addon-v2.php :
<?php
/*
Plugin Name: Tutor Paid Topic Addon V2
Description: Inject harga per topic langsung di Course Builder Tutor LMS 3.x+ (React SPA) dan otomatis buat WooCommerce Product
Version: 2.3
Author: Puji Ermanto
*/

if (!defined('ABSPATH')) exit;

// Load frontend module
if (file_exists(plugin_dir_path(__FILE__) . 'module/frontend.php')) {
    require_once plugin_dir_path(__FILE__) . 'module/frontend.php';
}

// Load role & registration service
// foreach (glob(plugin_dir_path(__FILE__) . 'service/*.php') as $service_file) {
//     require_once $service_file;
// }
// =========================================================
// Load service files setelah semua plugin lain siap
// =========================================================
add_action('plugins_loaded', function () {
    $service_path = plugin_dir_path(__FILE__) . 'service/*.php';
    foreach (glob($service_path) as $service_file) {
        require_once $service_file;
    }
}, 20);

// Hanya load manual kalau ingin pastikan ini selalu terakhir
$unlock_file = plugin_dir_path(__FILE__) . 'service/tutor-enroll-unlock.php';
if (file_exists($unlock_file)) {
    require_once $unlock_file;
}

/**
 * üîÅ Patch: Auto Sync Enrolled Courses Cache (ganti template_redirect lama)
 */
// add_action('template_redirect', function () {
//     if (!is_page(['dashboard', 'enrolled-courses'])) return;

//     $user_id = get_current_user_id();
//     if (!$user_id) return;

//     global $wpdb;
//     $table = "{$wpdb->prefix}tutor_enrolled";

//     // Ambil semua course_id yang user sudah enroll
//     $enrolled_course_ids = $wpdb->get_col($wpdb->prepare("
//         SELECT course_id FROM $table WHERE user_id = %d
//     ", $user_id));

//     if (!$enrolled_course_ids) return;

//     // Update tutor_total_enroll
//     update_user_meta($user_id, 'tutor_total_enroll', count($enrolled_course_ids));

//     // Update tutor_enrolled_courses
//     update_user_meta($user_id, 'tutor_enrolled_courses', $enrolled_course_ids);

//     // Update tutor_enrolled_courses_cache
//     $cache_key = 'tutor_enrolled_courses_cache';
//     $cached = [];
//     foreach ($enrolled_course_ids as $course_id) {
//         $cached[$course_id] = [
//             'course_id' => $course_id,
//             'enrolled_date' => current_time('mysql')
//         ];
//     }
//     update_user_meta($user_id, $cache_key, $cached);

//     // Pastikan user role tutor_student
//     $user = get_userdata($user_id);
//     if ($user && !in_array('tutor_student', (array) $user->roles)) {
//         $user->set_role('tutor_student');
//     }

//     error_log("[TPT-FIX] ‚úÖ Auto-sync Tutor enrolled cache untuk user $user_id");
// }, 20);

/**
 * üé® Load Cinematic Style for Tutor LMS Lessons
 */
add_action('wp_enqueue_scripts', function () {
    // hanya load di halaman lesson Tutor
    if (is_singular('lesson')) {
        wp_enqueue_style(
            'tpt-cinematic-style',
            plugin_dir_url(__FILE__) . 'assets/style.css',
            [],
            filemtime(plugin_dir_path(__FILE__) . 'assets/style.css') // versi dinamis anti-cache
        );
    }
});

// =====================
// 1Ô∏è‚É£ Load JS admin (fix untuk Tutor React Builder)
// =====================
add_action('admin_enqueue_scripts', function ($hook) {
    $is_tutor_builder = isset($_GET['page']) && (
        $_GET['page'] === 'tutor-course-builder' ||
        $_GET['page'] === 'tutor' ||
        strpos($hook, 'tutor') !== false
    );

    if ($is_tutor_builder) {
        wp_enqueue_script(
            'tpt-admin-js',
            plugin_dir_url(__FILE__) . 'assets/admin.js',
            ['jquery'],
            time(), // agar tidak kena cache
            true
        );
        wp_enqueue_style(
            'font-awesome',
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css'
        );
        wp_localize_script('tpt-admin-js', 'TPT_Ajax', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce'    => wp_create_nonce('tpt_nonce')
        ]);
    }
});

/**
 * üé¨ Load Cinematic Style + YouTube Player Fix
 */
add_action('wp_enqueue_scripts', function () {
    if (is_singular('lesson')) {
        // CSS cinematic
        wp_enqueue_style(
            'tpt-cinematic-style',
            plugin_dir_url(__FILE__) . 'assets/style.css',
            [],
            filemtime(plugin_dir_path(__FILE__) . 'assets/style.css')
        );

        // JS player auto-convert
        wp_enqueue_script(
            'tpt-player-fix',
            plugin_dir_url(__FILE__) . 'assets/player.js',
            [],
            filemtime(plugin_dir_path(__FILE__) . 'assets/player.js'),
            true
        );
    }
});


/**
 * 2Ô∏è‚É£ AJAX - Simpan harga per topic & buat produk WooCommerce
 */
add_action('wp_ajax_tpt_save_price', function () {
    check_ajax_referer('tpt_nonce', 'nonce');
    if (!current_user_can('edit_posts')) wp_send_json_error('Unauthorized');

    $title     = sanitize_text_field($_POST['title']);
    $course_id = intval($_POST['course_id']);
    $price     = intval($_POST['price']);

    if (!$title || !$course_id) wp_send_json_error('Invalid data');

    global $wpdb;
    $posts_table = $wpdb->prefix . 'posts';

    $topic_post_id = null;
    $attempts = 0;

    while (!$topic_post_id && $attempts < 3) {
        // cari topic langsung di course
        $topic_post_id = $wpdb->get_var($wpdb->prepare("
            SELECT ID FROM $posts_table
            WHERE post_title = %s
            AND post_parent = %d
            AND post_type IN ('topics','topic')
            LIMIT 1
        ", $title, $course_id));

        // cari lewat section parent kalau belum ketemu
        if (!$topic_post_id) {
            $topic_post_id = $wpdb->get_var($wpdb->prepare("
                SELECT t1.ID
                FROM {$wpdb->posts} t1
                INNER JOIN {$wpdb->posts} t2 ON t1.post_parent = t2.ID
                WHERE t1.post_title = %s
                AND t2.post_parent = %d
                AND t1.post_type IN ('topics','topic')
                LIMIT 1
            ", $title, $course_id));
        }

        if (!$topic_post_id) {
            usleep(300000);
            $attempts++;
        }
    }

    if (!$topic_post_id) wp_send_json_error('Topic not found in DB');

    update_post_meta($topic_post_id, '_tpt_price', $price);

    // buat / update produk WooCommerce
    // $wc_id = get_post_meta($topic_post_id, '_tpt_wc_id', true);

    // $course_title = get_the_title($course_id);
    // $topic_title  = get_the_title($topic_post_id);
    // $product_name = $course_title . ' ‚Äì ' . $topic_title;

    // if (!$wc_id) {
    //     $product = new WC_Product_Simple();
    //     $product->set_name($product_name);
    //     $product->set_regular_price($price);
    //     $product->set_status('publish'); // publish agar muncul
    //     $product->set_catalog_visibility('hidden');
    //     $product->save();

    //     update_post_meta($topic_post_id, '_tpt_wc_id', $product->get_id());
    //     update_post_meta($product->get_id(), '_tpt_topic_id', $topic_post_id);
    //     update_post_meta($product->get_id(), '_tutor_course_id', $course_id); // üîπ tambahkan juga course ID

    //     $wc_id = $product->get_id();
    // } else {
    //     $product = wc_get_product($wc_id);
    //     if ($product) {
    //         $product->set_name($product_name);
    //         $product->set_regular_price($price);
    //         $product->set_status('publish');
    //         $product->save();
    //     }
    // }
    // buat / update produk WooCommerce
    $wc_id = get_post_meta($topic_post_id, '_tpt_wc_id', true);

    $course_title = get_the_title($course_id);
    $topic_title  = get_the_title($topic_post_id);
    $product_name = $course_title . ' ‚Äì ' . $topic_title;

    if (!$wc_id) {
        $product = new WC_Product_Simple();
        $product->set_name($product_name);
        $product->set_regular_price($price);
        $product->set_status('publish'); // publish agar muncul
        $product->set_catalog_visibility('hidden');
        $product->save();

        update_post_meta($topic_post_id, '_tpt_wc_id', $product->get_id());
        update_post_meta($product->get_id(), '_tpt_topic_id', $topic_post_id);
        update_post_meta($product->get_id(), '_tutor_course_id', $course_id); // üîπ tambahkan juga course ID

        $wc_id = $product->get_id();
    } else {
        $product = wc_get_product($wc_id);
        if ($product) {
            $product->set_name($product_name);
            $product->set_regular_price($price);
            $product->set_status('publish');
            $product->save();
        }
    }


    wp_send_json_success([
        'topic_id' => $topic_post_id,
        'price'    => $price,
        'wc_id'    => $wc_id,
    ]);
});


/**
 * üîß  Fix Tutor LMS "Price is required" error
 *  Inject dummy pricing before Tutor validates input
 */
add_filter('tutor_course_builder_save_data_before_validation', function ($data) {
    // Jika tidak ada field pricing dari React, tambahkan dummy
    if (empty($data['pricing']) || empty($data['pricing']['regular_price'])) {

        // Cari harga topic pertama (kalau ada)
        if (!empty($data['course_id'])) {
            global $wpdb;
            $topics = $wpdb->get_results($wpdb->prepare("
                SELECT ID FROM {$wpdb->posts}
                WHERE post_parent = %d
                AND post_type IN ('topics','topic')
                ORDER BY menu_order ASC LIMIT 1
            ", intval($data['course_id'])));

            if ($topics) {
                $first_topic_id = $topics[0]->ID;
                $first_price = intval(get_post_meta($first_topic_id, '_tpt_price', true));
                if ($first_price > 0) {
                    $data['pricing']['regular_price'] = $first_price;
                } else {
                    $data['pricing']['regular_price'] = 0;
                }
            } else {
                $data['pricing']['regular_price'] = 0;
            }
        } else {
            $data['pricing']['regular_price'] = 0;
        }
    }

    return $data;
}, 10, 1);

// =====================
// Hook: Save price & WC product
// =====================
add_action('save_post', function ($post_id, $post, $update) {
    if ($post->post_type !== 'tutor_lesson') return;

    $course_id = get_post_meta($post_id, '_tutor_course_id', true);
    if (!$course_id) return;

    $price = isset($_POST['_tpt_price']) ? floatval($_POST['_tpt_price']) : 0;
    update_post_meta($post_id, '_tpt_price', $price);

    // Patch: buat / update WC product unik per course
    tpt_create_or_update_wc_product($post_id, $price, $course_id);
}, 10, 3);

// =====================
// Function: Create / update WooCommerce product per topic
// =====================
// function tpt_create_or_update_wc_product($topic_id, $price, $course_id)
// {
//     if (!$topic_id || !$course_id) return false;

//     $topic_title  = get_the_title($topic_id);
//     $course_title = get_the_title($course_id);

//     $product_name = $course_title . ' ‚Äì ' . $topic_title;

//     $wc_id = get_post_meta($topic_id, '_tpt_wc_id', true);

//     if (!$wc_id) {
//         $product = new WC_Product_Simple();
//         $product->set_name($product_name);
//         $product->set_regular_price($price);
//         $product->set_status('publish');
//         $product->set_catalog_visibility('hidden');
//         $product->save();

//         update_post_meta($topic_id, '_tpt_wc_id', $product->get_id());
//         update_post_meta($product->get_id(), '_tpt_topic_id', $topic_id);

//         $wc_id = $product->get_id();
//     } else {
//         $product = wc_get_product($wc_id);
//         if ($product) {
//             $product->set_name($product_name);
//             $product->set_regular_price($price);
//             $product->set_status('publish');
//             $product->save();
//         }
//     }

//     return $wc_id;
// }
// Versi patch :
function tpt_create_or_update_wc_product($topic_id, $price, $course_id)
{
    if (!$topic_id || !$course_id) return false;

    $topic_title  = get_the_title($topic_id);
    $course_title = get_the_title($course_id);

    $product_name = $course_title . ' ‚Äì ' . $topic_title;

    $wc_id = get_post_meta($topic_id, '_tpt_wc_id', true);

    if (!$wc_id) {
        // üîπ Buat produk baru
        $product = new WC_Product_Simple();
        $product->set_name($product_name);
        $product->set_regular_price($price);
        $product->set_status('publish');
        $product->set_catalog_visibility('hidden');
        $product->save();

        // üîπ Simpan relasi meta
        update_post_meta($topic_id, '_tpt_wc_id', $product->get_id());
        update_post_meta($product->get_id(), '_tpt_topic_id', $topic_id);
        update_post_meta($product->get_id(), '_tutor_course_id', $course_id); // ‚úÖ Tambahkan baris ini

        $wc_id = $product->get_id();
    } else {
        // üîπ Update produk lama
        $product = wc_get_product($wc_id);
        if ($product) {
            $product->set_name($product_name);
            $product->set_regular_price($price);
            $product->set_status('publish');
            $product->save();

            // ‚úÖ Pastikan meta selalu sinkron
            update_post_meta($product->get_id(), '_tutor_course_id', $course_id);
            update_post_meta($product->get_id(), '_tpt_topic_id', $topic_id);
        }
    }

    return $wc_id;
}


// =====================
// REST API endpoint: Buy topic
// =====================
add_action('rest_api_init', function () {
    register_rest_route('tutor-paid-topic/v2', '/buy', [
        'methods' => 'POST',
        'callback' => function ($request) {
            $topic_id  = $request->get_param('topic_id');
            $course_id = $request->get_param('course_id');
            $user_id   = get_current_user_id();

            if (!$topic_id || !$course_id || !$user_id) {
                return ['status' => 'error', 'message' => 'Missing parameter'];
            }

            $wc_id = get_post_meta($topic_id, '_tpt_wc_id', true);
            if (!$wc_id) return ['status' => 'error', 'message' => 'WC Product not found'];

            // Tambahkan ke cart
            WC()->cart->add_to_cart($wc_id);

            return ['status' => 'success', 'message' => 'Topic added to cart'];
        },
        'permission_callback' => '__return_true', // <=== ini tambahan
    ]);
});

add_action('rest_api_init', function () {
    register_rest_route('tpt/v1', '/user-progress', [
        'methods' => 'GET',
        'callback' => function (WP_REST_Request $r) {
            $user_id = intval($r->get_param('user_id')) ?: get_current_user_id();
            return [
                'completed' => get_user_meta($user_id, '_tpt_completed_topics', true),
                'purchased' => get_user_meta($user_id, '_tpt_purchased_topics', true),
            ];
        },
        'permission_callback' => '__return_true'
    ]);
});


// =====================
// 4Ô∏è‚É£ AJAX get price
// =====================
add_action('wp_ajax_tpt_get_price', function () {
    check_ajax_referer('tpt_nonce', 'nonce');

    $title     = sanitize_text_field($_POST['title']);
    $course_id = intval($_POST['course_id']);

    global $wpdb;
    $posts_table = $wpdb->prefix . 'posts';

    $topic_post_id = $wpdb->get_var($wpdb->prepare("
        SELECT ID FROM $posts_table
        WHERE post_title = %s
        AND post_parent = %d
        AND post_type IN ('topics','topic')
        LIMIT 1
    ", $title, $course_id));

    if (!$topic_post_id) {
        $topic_post_id = $wpdb->get_var($wpdb->prepare("
            SELECT l.ID
            FROM $posts_table l
            INNER JOIN $posts_table t ON t.ID = l.post_parent
            WHERE l.post_title = %s
            AND t.post_parent = %d
            AND l.post_type = 'lesson'
            LIMIT 1
        ", $title, $course_id));
    }

    $price = $topic_post_id ? get_post_meta($topic_post_id, '_tpt_price', true) : 0;
    wp_send_json_success([
        'price'    => intval($price),
        'topic_id' => intval($topic_post_id)
    ]);
});

// =====================
// 5Ô∏è‚É£ AJAX add to cart
// =====================
add_action('wp_ajax_tpt_add_to_cart', 'tpt_add_to_cart');
add_action('wp_ajax_nopriv_tpt_add_to_cart', 'tpt_add_to_cart');
function tpt_add_to_cart()
{
    $product_id = intval($_POST['product_id'] ?? 0);
    if (!$product_id) wp_send_json_error('Invalid product');

    if (WC()->cart->add_to_cart($product_id)) {
        wp_send_json_success();
    } else {
        wp_send_json_error('Failed to add to cart');
    }
}

// =====================
// 6Ô∏è‚É£ Update completed topic saat order completed
// =====================
add_action('woocommerce_order_status_completed', function ($order_id) {
    $order = wc_get_order($order_id);
    $user_id = $order->get_user_id();

    foreach ($order->get_items() as $item) {
        $topic_id = get_post_meta($item->get_product_id(), '_tpt_topic_id', true);
        if ($topic_id) {
            $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
            if (!in_array($topic_id, $completed)) {
                $completed[] = $topic_id;
                update_user_meta($user_id, '_tpt_completed_topics', $completed);
            }
        }
    }
});

// =====================
// 7Ô∏è‚É£ REST API: get all topic prices
// =====================
add_action('rest_api_init', function () {
    register_rest_route('tpt/v1', '/get-topic-prices', [
        'methods'  => 'GET',
        'callback' => function (WP_REST_Request $request) {
            $course_id = intval($request->get_param('course_id'));
            if (!$course_id) return new WP_REST_Response([
                'status_code' => 400,
                'message'     => 'Missing or invalid course_id',
            ], 400);

            global $wpdb;

            // Ambil semua topic dengan post_type = 'topics' (fix untuk DB kamu)
            $topics = $wpdb->get_results($wpdb->prepare("
                SELECT ID, post_title
                FROM {$wpdb->posts}
                WHERE post_parent = %d
                AND post_type = 'topics'
                AND post_status = 'publish'
                ORDER BY menu_order ASC
            ", $course_id));

            if (!$topics) return new WP_REST_Response([
                'status_code' => 404,
                'message'     => 'No topics found for this course',
            ], 404);

            $data = [];
            $prices = [];
            foreach ($topics as $topic) {
                $price = intval(get_post_meta($topic->ID, '_tpt_price', true) ?: 0);
                $data[] = [
                    'id'    => intval($topic->ID),
                    'title' => $topic->post_title,
                    'price' => $price
                ];
                if ($price > 0) $prices[] = $price;
            }

            return new WP_REST_Response([
                'status_code' => 200,
                'message'     => 'Course topics fetched successfully',
                'data'        => [
                    'course_id' => $course_id,
                    'topics'    => $data,
                    'price_min' => $prices ? min($prices) : 0,
                    'price_max' => $prices ? max($prices) : 0
                ]
            ], 200);
        },
        'permission_callback' => '__return_true'
    ]);

    // Route tpt-card/v2/get-course-prices
    register_rest_route('tpt-card/v2', '/get-course-prices', [
        'methods' => 'GET',
        'callback' => function ($request) {
            $course_id = $request->get_param('course_id');
            if (!$course_id) return [];

            $topics = tutor_utils()->get_course_topics($course_id);
            $data = [];

            foreach ($topics as $topic) {
                $price = get_post_meta($topic->ID, '_tpt_price', true);
                $data[] = [
                    'topic_id' => $topic->ID,
                    'title' => get_the_title($topic->ID),
                    'price' => $price ? $price : 0
                ];
            }

            return $data;
        },
        'permission_callback' => '__return_true', // <=== ini tambahan
    ]);
});

// =====================
// 8Ô∏è‚É£ Frontend: inject Buy Topic button dengan loader
// =====================
add_action('wp_footer', function () {
    if (!is_singular('courses')) return;
    $completed = get_user_meta(get_current_user_id(), '_tpt_completed_topics', true) ?: [];
?>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const userCompleted = <? php echo json_encode($completed); ?>;

        document.querySelectorAll('.tutor-accordion-item').forEach(item => {
            const topicId = parseInt(item.dataset.topicId);
            const wcId = parseInt(item.dataset.wcId);
            if (!wcId || !topicId) return;

            const prevTopicId = item.dataset.prevTopicId ? parseInt(item.dataset.prevTopicId) : 0;
            const canBuy = !prevTopicId || userCompleted.includes(prevTopicId);

            const btn = document.createElement('button');
            btn.textContent = canBuy ? "Buy Topic" : "Selesaikan Bab sebelumnya";
            btn.disabled = !canBuy;
            btn.className = "tpt-btn-buy-topic";
            Object.assign(btn.style, {
                marginTop: "8px",
                padding: "6px 18px",
                borderRadius: "6px",
                border: "none",
                cursor: canBuy ? "pointer" : "not-allowed",
                background: canBuy ? "#ED2D56" : "#ccc",
                color: "#fff",
                fontWeight: "600"
            });

            if (canBuy) {
                btn.addEventListener('click', () => {
                    const originalText = btn.textContent;
                    btn.textContent = "Loading...";
                    btn.disabled = true;
                    jQuery.post('<?php echo admin_url("admin-ajax.php"); ?>', {
                        action: "tpt_add_to_cart",
                        product_id: wcId
                    }).done(() => {
                        btn.textContent = "Added!";
                        btn.style.background = "#999";
                    }).fail(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    });
                });
            }

            item.querySelector('.tutor-course-content-list')?.appendChild(btn);
        });
    });
</script>
<?php
});


/**
 * üõ† PATCH: Auto Sync Tutor LMS enrolled courses cache
 * Bisa dipanggil via URL / cron / template_redirect
 */
add_action('init', function () {
    global $wpdb;
    $table_enroll = $wpdb->prefix . 'tutor_enrolled';

    $user_ids = $wpdb->get_col("SELECT DISTINCT user_id FROM $table_enroll");
    if (!$user_ids) return;

    foreach ($user_ids as $user_id) {
        $enrolled_course_ids = $wpdb->get_col($wpdb->prepare("
            SELECT course_id FROM $table_enroll WHERE user_id = %d
        ", $user_id)) ?: [];

        update_user_meta($user_id, 'tutor_total_enroll', count($enrolled_course_ids));
        update_user_meta($user_id, 'tutor_enrolled_courses', $enrolled_course_ids);

        $cached = [];
        foreach ($enrolled_course_ids as $course_id) {
            $cached[$course_id] = [
                'course_id' => $course_id,
                'enrolled_date' => current_time('mysql')
            ];
        }
        update_user_meta($user_id, 'tutor_enrolled_courses_cache', $cached);

        $user = get_userdata($user_id);
        if ($user && !in_array('tutor_student', (array)$user->roles)) {
            $user->set_role('tutor_student');
        }

        error_log("[TPT-PATCH] ‚úÖ Sync enroll cache untuk user $user_id selesai, courses: " . implode(',', $enrolled_course_ids));
    }
});

/**
 * üß© PATCH: Auto sync _tpt_purchased_topics saat order WooCommerce di-mark completed
 * Tujuan: agar topic langsung unlocked tanpa harus logout/login
 */
add_action('woocommerce_order_status_changed', function ($order_id, $old_status, $new_status) {
    if ($new_status !== 'completed') return;

    $order = wc_get_order($order_id);
    if (!$order) return;

    $user_id = $order->get_user_id();
    if (!$user_id) return;

    global $wpdb;

    // Ambil semua item dari order
    foreach ($order->get_items() as $item) {
        $product_id = $item->get_product_id();
        if (!$product_id) continue;

        // Cek apakah produk ini terkait dengan topic
        $topic_id = $wpdb->get_var($wpdb->prepare("
            SELECT post_id FROM {$wpdb->postmeta}
            WHERE meta_key = '_tpt_wc_id' AND meta_value = %d
        ", $product_id));

        if ($topic_id) {
            // Tambahkan ke daftar purchased
            $purchased = get_user_meta($user_id, '_tpt_purchased_topics', true);
            if (!is_array($purchased)) $purchased = [];

            if (!in_array($topic_id, $purchased)) {
                $purchased[] = $topic_id;
                update_user_meta($user_id, '_tpt_purchased_topics', array_unique($purchased));
                error_log("[TPT-PATCH] ‚úÖ Topic $topic_id ditambahkan ke _tpt_purchased_topics user $user_id");
            }
        }
    }
}, 10, 3);


/**
 * üîÅ Force refresh _tpt_purchased_topics setiap kali user buka halaman course
 * agar status On Hold -> Completed langsung ter-update tanpa logout.
 */
add_action('template_redirect', function () {
    if (!is_singular(['courses', 'tutor_course', 'lesson'])) return;

    $user_id = get_current_user_id();
    if (!$user_id) return;

    // Ambil semua order WooCommerce user
    $orders = wc_get_orders([
        'customer_id' => $user_id,
        'status'      => ['completed'],
        'limit'       => -1,
    ]);

    if (!$orders) return;

    global $wpdb;
    $topics = [];

    foreach ($orders as $order) {
        foreach ($order->get_items() as $item) {
            $pid = $item->get_product_id();
            $tid = $wpdb->get_var($wpdb->prepare("
                SELECT post_id FROM {$wpdb->postmeta}
                WHERE meta_key = '_tpt_wc_id' AND meta_value = %d
            ", $pid));
            if ($tid) $topics[] = intval($tid);
        }
    }

    if (!empty($topics)) {
        $existing = get_user_meta($user_id, '_tpt_purchased_topics', true);
        if (!is_array($existing)) $existing = [];

        $merged = array_unique(array_merge($existing, $topics));
        update_user_meta($user_id, '_tpt_purchased_topics', $merged);
    }
}, 30);

module/frontend.php :
<?php
if (!defined('ABSPATH')) exit;

/**
 * üîπ Show Topic Price Range on Course Card
 */
add_filter('tutor_course_card_price_html', function ($price_html, $course_id) {
    global $wpdb;
    $topics = $wpdb->get_results($wpdb->prepare("
        SELECT ID, pm.meta_value AS price
        FROM {$wpdb->posts} p
        LEFT JOIN {$wpdb->postmeta} pm ON pm.post_id = p.ID AND pm.meta_key = '_tpt_price'
        WHERE p.post_parent = %d AND p.post_type IN ('topics','topic')
        ORDER BY p.menu_order ASC
    ", $course_id));

    if (!$topics) return $price_html;

    $prices = array_map('intval', wp_list_pluck($topics, 'price'));
    $min = min($prices);
    $max = max($prices);

    return ($min === $max)
        ? 'Rp ' . number_format($min, 0, ',', '.')
        : 'Rp ' . number_format($min, 0, ',', '.') . ' ‚Äì Rp ' . number_format($max, 0, ',', '.');
}, 10, 2);


/**
 * üîπ Inject JS on Frontend - Replace default Tutor price in Acadia course card with loading spinner
 */
add_action('wp_footer', function () {
?>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const cards = document.querySelectorAll('.tp-course-item');

        for (const card of cards) {
            const btn = card.querySelector('[data-course-id]');
            const courseId = btn ? btn.dataset.courseId : null;
            if (!courseId) continue;

            const priceArea = card.querySelector('.tp-course-pricing, .tp-course-btn .tutor-course-price');
            if (!priceArea) continue;

            // Spinner sebelum API call
            const spinner = document.createElement('div');
            spinner.className = 'tpt-price-spinner';
            spinner.innerHTML = '<span></span><span></span><span></span>';
            priceArea.innerHTML = '';
            priceArea.appendChild(spinner);

            try {
                const res = await fetch(`/wp-json/tpt/v1/get-topic-prices?course_id=${courseId}&t=${Date.now()}`);
                const data = await res.json();

                const min = Number(data.data.price_min || 0);
                const max = Number(data.data.price_max || 0);

                const defaultPriceEls = card.querySelectorAll('.tutor-item-price');
                defaultPriceEls.forEach(el => el.remove());

                const priceWrapper = document.createElement('div');
                priceWrapper.className = 'tpt-course-price-wrapper';

                if (min === 0 && max === 0) {
                    priceWrapper.innerHTML = '';
                } else if (min === max) {
                    priceWrapper.innerHTML = `<span class="tpt-course-price">Rp ${min.toLocaleString('id-ID')}</span>`;
                } else {
                    priceWrapper.innerHTML = `<span class="tpt-course-price">Rp ${min.toLocaleString('id-ID')} ‚Äì Rp ${max.toLocaleString('id-ID')}</span>`;
                }

                priceArea.innerHTML = '';
                priceArea.appendChild(priceWrapper);

            } catch (e) {
                console.warn('Gagal ambil harga topik:', e);
                priceArea.innerHTML = '<span class="tpt-price-error">Gagal memuat harga</span>';
            }
        }
    });
</script>

<style>
    /* Styling harga baru */
    .tpt-course-price-wrapper {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 6px;
        font-size: 15px;
    }

    .tpt-course-total {
        color: #555;
        font-weight: 500;
    }

    .tpt-course-price {
        color: #3e64de;
        font-weight: 700;
    }

    /* Spinner */
    .tpt-price-spinner {
        display: flex;
        align-items: center;
        gap: 3px;
        height: 16px;
    }

    .tpt-price-spinner span {
        display: block;
        width: 4px;
        height: 16px;
        background: #3e64de;
        animation: tpt-spinner 1s infinite ease-in-out;
    }

    .tpt-price-spinner span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .tpt-price-spinner span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes tpt-spinner {

        0%,
        40%,
        100% {
            transform: scaleY(0.4);
        }

        20% {
            transform: scaleY(1.0);
        }
    }

    /* Sembunyikan harga default Tutor bawaan */
    .tutor-item-price,
    .tutor-course-price {
        display: none !important;
    }

    .single-course .tpt-course-price-wrapper {
        font-size: 16px;
        color: #ED2D56;
        font-weight: 700;
    }

    .tpt-price-error {
        color: #ED2D56;
        font-weight: 500;
        font-size: 14px;
    }
</style>
<?php
});

/**
 * üîπ FRONTEND: Lock Indicator + Badge + Buy Button (Final with Order Status)
 */
add_action('wp_footer', function () {
    if (!is_singular(['courses', 'tutor_course', 'lesson'])) return;

    $user_id = get_current_user_id();
    if (!$user_id) return;

    $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
    $purchased = get_user_meta($user_id, '_tpt_purchased_topics', true) ?: [];

    global $wpdb;

    $course_id = get_post_meta(get_the_ID(), '_tutor_course_id', true);
    if (!$course_id) {
        $parent = wp_get_post_parent_id(get_the_ID());
        if ($parent) $course_id = wp_get_post_parent_id($parent);
    }
    if (!$course_id) return;

    $topics = $wpdb->get_results($wpdb->prepare("
        SELECT t.ID, p2.meta_value AS wc_id, pm_price.meta_value AS price
        FROM {$wpdb->posts} t
        LEFT JOIN {$wpdb->postmeta} p2 ON p2.post_id = t.ID AND p2.meta_key = '_tpt_wc_id'
        LEFT JOIN {$wpdb->postmeta} pm_price ON pm_price.post_id = t.ID AND pm_price.meta_key = '_tpt_price'
        WHERE t.post_parent = %d
          AND t.post_type IN ('topics','topic')
          AND t.post_status='publish'
        ORDER BY t.menu_order ASC
    ", $course_id));

    if (!$topics) return;

    // üîπ Ambil semua order WooCommerce user
    $orders_completed = wc_get_orders([
        'customer_id' => $user_id,
        'status'      => ['completed'],
        'limit'       => -1,
    ]);
    $orders_pending = wc_get_orders([
        'customer_id' => $user_id,
        'status'      => ['pending', 'on-hold', 'processing'],
        'limit'       => -1,
    ]);

    $orderedCompleted = [];
    $orderedPending = [];

    foreach ($orders_completed as $order) {
        foreach ($order->get_items() as $item) {
            $pid = $item->get_product_id();
            $tid = $wpdb->get_var($wpdb->prepare("SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key='_tpt_wc_id' AND meta_value=%d", $pid));
            if ($tid) $orderedCompleted[] = intval($tid);
        }
    }
    foreach ($orders_pending as $order) {
        foreach ($order->get_items() as $item) {
            $pid = $item->get_product_id();
            $tid = $wpdb->get_var($wpdb->prepare("SELECT post_id FROM {$wpdb->postmeta} WHERE meta_key='_tpt_wc_id' AND meta_value=%d", $pid));
            if ($tid) $orderedPending[] = intval($tid);
        }
    }
?>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const topics = <? php echo json_encode($topics); ?>;
        const completed = <? php echo json_encode($completed); ?>;
        const purchased = <? php echo json_encode($purchased); ?>;
        const orderedCompleted = <? php echo json_encode($orderedCompleted); ?>;
        const orderedPending = <? php echo json_encode($orderedPending); ?>;

        function renderBuyButtons() {
            document.querySelectorAll('.tutor-course-topic').forEach((el, index, all) => {
                if (el.dataset.rendered) return;
                el.dataset.rendered = "1";

                const match = el.className.match(/tutor-course-topic-(\d+)/);
                const topicId = match ? parseInt(match[1]) : 0;
                if (!topicId) return;

                const tdata = topics.find(t => parseInt(t.ID) === topicId);
                if (!tdata) return;

                const price = parseInt(tdata.price || 0);
                const wcId = parseInt(tdata.wc_id || 0);
                const prev = index > 0 ? all[index - 1] : null;
                const prevId = prev ? parseInt(prev.className.match(/tutor-course-topic-(\d+)/)?.[1] || 0) : 0;
                const isFirst = index === 0;

                const unlocked = isFirst || completed.includes(prevId) || purchased.includes(topicId);
                const header = el.querySelector('.tutor-accordion-item-header');
                const headerRow = header?.querySelector('.tutor-row');
                if (!header || !headerRow) return;

                const rightCol = document.createElement('div');
                rightCol.className = 'tutor-col-auto tutor-align-self-center';
                rightCol.style.display = 'flex';
                rightCol.style.alignItems = 'center';
                rightCol.style.gap = '6px';

                // =====================
                // STATUS HANDLER
                // =====================
                if (orderedCompleted.includes(topicId) || purchased.includes(topicId)) {
                    // ‚úÖ Order complete / sudah purchased
                    const badge = document.createElement('span');
                    badge.textContent = "‚úÖ Order: Completed";
                    badge.style.cssText = `
                    background:#D4EDDA;
                    color:#155724;
                    padding:4px 10px;
                    border-radius:6px;
                    font-size:12px;
                    font-weight:600;
                `;
                    rightCol.appendChild(badge);
                    header.style.opacity = "1";
                    header.style.pointerEvents = "auto";

                } else if (orderedPending.includes(topicId)) {
                    // ‚è≥ On Hold / Processing
                    const badge = document.createElement('span');
                    badge.textContent = "‚è≥ On Hold / Processing";
                    badge.style.cssText = `
                    background:#FFF3CD;
                    color:#856404;
                    padding:4px 10px;
                    border-radius:6px;
                    font-size:12px;
                    font-weight:600;
                `;
                    rightCol.appendChild(badge);
                    header.style.opacity = "0.8";
                    header.style.pointerEvents = "none";

                } else if (!unlocked) {
                    // üîí Locked
                    const badge = document.createElement('span');
                    badge.textContent = `üîí Locked ¬∑ Rp ${price.toLocaleString('id-ID')}`;
                    badge.style.cssText = `
                    background:#FFE4E9;
                    color:#ED2D56;
                    padding:4px 10px;
                    border-radius:8px;
                    font-size:12px;
                    font-weight:600;
                `;
                    rightCol.appendChild(badge);
                    header.style.opacity = "0.6";
                    header.style.pointerEvents = "none";

                } else {
                    // üõí Belum dibeli & boleh dibeli
                    const btn = document.createElement('button');
                    btn.textContent = "Buy Topic";
                    btn.className = 'tpt-btn-buy-topic';
                    btn.style.cssText = `
                    padding:6px 14px;
                    border:none;
                    border-radius:6px;
                    font-weight:600;
                    font-size:13px;
                    cursor:pointer;
                    background:#ED2D56;
                    color:white;
                    transition:all .25s ease;
                `;
                    btn.addEventListener('mouseenter', () => {
                        btn.style.background = '#fff';
                        btn.style.color = '#ED2D56';
                        btn.style.border = '1px solid #ED2D56';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.background = '#ED2D56';
                        btn.style.color = '#fff';
                        btn.style.border = 'none';
                    });
                    btn.addEventListener('click', () => {
                        btn.disabled = true;
                        btn.innerHTML = `<span class="tpt-spinner" style="display:inline-block;width:14px;height:14px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;margin-right:6px;animation:tpt-spin 0.8s linear infinite;"></span> Menambahkan...`;
                        jQuery.post('<?php echo admin_url("admin-ajax.php"); ?>', {
                            action: "tpt_add_to_cart",
                            product_id: wcId
                        }).done(() => {
                            btn.innerHTML = `<i class="fa fa-check"></i> Berhasil!`;
                            btn.style.background = "#444";
                            setTimeout(() => window.location.href = "<?php echo wc_get_cart_url(); ?>", 800);
                        }).fail(() => {
                            btn.innerHTML = "Buy Topic";
                            btn.disabled = false;
                        });
                    });
                    rightCol.appendChild(btn);
                }

                const oldRight = headerRow.querySelector('.tutor-col-auto');
                if (oldRight) oldRight.remove();
                headerRow.appendChild(rightCol);
            });
        }

        renderBuyButtons();
        document.body.addEventListener("tutor_course_topics_rendered", renderBuyButtons);
    });
</script>
<?php
});

service/tutor-enroll-unlock.php :
<?php
if (!defined('ABSPATH')) exit;

/**
 * ü©π Override Tutor lock system untuk lesson pertama
 * - Jika user sudah enrolled course dan topic pertama
 *   maka lesson pertama selalu bisa diakses tanpa redirect locked
 */
remove_action('template_redirect', 'tutor_lesson_access_restriction');

add_action('template_redirect', function () {
    if (!is_singular('lesson')) return;

    $lesson_id = get_the_ID();
    $topic_id = wp_get_post_parent_id($lesson_id);
    $course_id = get_post_meta($lesson_id, '_tutor_course_id', true);
    if (!$course_id && $topic_id) {
        $course_id = wp_get_post_parent_id($topic_id);
    }

    $user_id = get_current_user_id();
    if (!$user_id || !$course_id) return;

    global $wpdb;
    $enrolled = $wpdb->get_var($wpdb->prepare("
        SELECT COUNT(*) FROM {$wpdb->prefix}tutor_enrolled
        WHERE course_id = %d AND user_id = %d
    ", $course_id, $user_id));

    if (!$enrolled) {
        wp_safe_redirect(get_permalink($course_id) . '?locked=enroll');
        exit;
    }

    // Ambil topic pertama
    $all_topics = get_posts([
        'post_type' => ['topics', 'topic'],
        'post_parent' => $course_id,
        'orderby' => 'menu_order',
        'order' => 'ASC',
        'fields' => 'ids'
    ]);

    $first_topic_id = $all_topics ? $all_topics[0] : 0;

    // Lesson dari topic pertama selalu bisa diakses
    if ($topic_id && $topic_id == $first_topic_id) {
        return; // ‚úÖ allow access
    }

    // Jika bukan topic pertama, cek meta purchased/completed
    $purchased = get_user_meta($user_id, '_tpt_purchased_topics', true) ?: [];
    $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];

    $topic_index = array_search($topic_id, $all_topics);
    $prev_topic_id = $topic_index > 0 ? $all_topics[$topic_index - 1] : 0;

    $can_access = in_array($topic_id, $purchased) && in_array($prev_topic_id, $completed);

    if (!$can_access) {
        wp_safe_redirect(get_permalink($course_id) . '?locked=' . $topic_id);
        exit;
    }
}, 0); // priority 0 supaya jalan sebelum Tutor core

/**
 * üîπ 1. Auto-enroll user ke course setelah order completed
 */
add_action('woocommerce_order_status_completed', function ($order_id) {
    $order = wc_get_order($order_id);
    if (!$order) return;
    $user_id = $order->get_user_id();
    if (!$user_id) return;

    global $wpdb;
    $table = $wpdb->prefix . 'tutor_enrolled';

    foreach ($order->get_items() as $item) {
        $product_id = $item->get_product_id();
        $course_id  = get_post_meta($product_id, '_tutor_course_id', true);
        if (!$course_id) continue;

        $exists = $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $table WHERE user_id=%d AND course_id=%d", $user_id, $course_id));
        if (!$exists) {
            $wpdb->insert($table, [
                'user_id' => $user_id,
                'course_id' => $course_id,
                'enrolled_on' => current_time('mysql')
            ]);
        }
    }
});

/**
 * üîπ 2. Filter akses topic (Tutor course_get_topics)
 * - Topic pertama: unlocked otomatis jika user sudah enroll course
 * - Topic selanjutnya: locked default kecuali topic sebelumnya sudah completed & topic ini sudah dibeli
 */
add_filter('tutor_course_get_topics', function ($topics, $course_id) {
    $user_id = get_current_user_id();
    if (!$user_id) return $topics;

    $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
    $purchased = get_user_meta($user_id, '_tpt_purchased_topics', true) ?: [];

    $prev_topic_id = null;
    foreach ($topics as $i => &$topic) {
        $topic_id = $topic->ID;

        // Topic pertama: auto unlock jika user sudah enroll course
        if ($i === 0) {
            // Topic pertama selalu terbuka
            $topic->lesson_accessibility = 'accessible';
            $topic->can_access = true;
            $topic->is_locked = false;
        } else {
            $can_unlock = in_array($prev_topic_id, $completed) && in_array($topic_id, $purchased);
            $topic->lesson_accessibility = $can_unlock ? 'accessible' : 'locked';
            $topic->can_access = $can_unlock;
            $topic->is_locked = !$can_unlock;
        }


        $prev_topic_id = $topic_id;
    }
    return $topics;
}, 10, 2);


/**
 * üîπ 3. Cegah akses langsung ke lesson dari topic yang belum dibeli
 */
add_action('template_redirect', function () {
    if (!is_singular('lesson')) return;

    global $wpdb;
    $lesson_id = get_the_ID();
    $topic_id  = wp_get_post_parent_id($lesson_id);
    $course_id = get_post_meta($lesson_id, '_tutor_course_id', true);

    // ‚úÖ jika _tutor_course_id kosong, ambil dari parent topic
    if (!$course_id && $topic_id) {
        $course_id = wp_get_post_parent_id($topic_id);
    }

    $user_id = get_current_user_id();
    if (!$user_id || !$course_id) return;

    $purchased = get_user_meta($user_id, '_tpt_purchased_topics', true) ?: [];
    $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];

    // Ambil semua topic urut berdasarkan menu order
    $all_topics = $wpdb->get_col($wpdb->prepare("
        SELECT ID FROM {$wpdb->posts}
        WHERE post_parent = %d
        AND post_type IN ('topics','topic')
        AND post_status = 'publish'
        ORDER BY menu_order ASC
    ", $course_id));

    $first_topic_id = $all_topics ? $all_topics[0] : 0;

    // ‚úÖ Cek apakah user sudah enroll di course
    $enrolled = $wpdb->get_var($wpdb->prepare("
        SELECT COUNT(*) FROM {$wpdb->prefix}tutor_enrolled
        WHERE course_id = %d AND user_id = %d
    ", $course_id, $user_id));

    $can_access = false;

    // ‚úÖ Topik pertama auto unlock jika user sudah enroll course
    if ($topic_id == $first_topic_id && $enrolled) {
        $can_access = true;

        // pastikan meta completed ikut ditandai agar filter topic detect unlocked
        $completed_meta = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
        if (!in_array($first_topic_id, $completed_meta)) {
            $completed_meta[] = $first_topic_id;
            update_user_meta($user_id, '_tpt_completed_topics', array_unique($completed_meta));
        }
    } else {
        // topic berikut hanya jika sudah beli dan topic sebelumnya complete
        $topic_index = array_search($topic_id, $all_topics);
        $prev_topic_id = $topic_index > 0 ? $all_topics[$topic_index - 1] : 0;
        $can_access = in_array($topic_id, $purchased) && in_array($prev_topic_id, $completed);
    }

    if (!$can_access) {
        wp_safe_redirect(get_permalink($course_id) . '?locked=' . $topic_id);
        exit;
    }
});


/**
 * üîπ 4. Update completed topic otomatis ketika user menyelesaikan lesson terakhir
 */
// add_action('tutor_lesson_completed_after', function ($lesson_id, $user_id) {
//     $topic_id = intval(get_post_meta($lesson_id, '_tutor_topic_id', true));
//     if (!$topic_id) {
//         $topic_id = wp_get_post_parent_id($lesson_id);
//     }

//     if (!$topic_id) return;

//     $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
//     if (!in_array($topic_id, $completed)) {
//         $completed[] = $topic_id;
//         update_user_meta($user_id, '_tpt_completed_topics', $completed);
//     }
// }, 10, 2);
add_action('tutor_lesson_completed_after', function ($lesson_id, $user_id) {
    // ambil topic ID dari lesson
    $topic_id = (int) get_post_meta($lesson_id, '_tutor_topic_id', true);
    if (!$topic_id) {
        $topic_id = wp_get_post_parent_id($lesson_id);
    }

    // pastikan lesson benar-benar terakhir di topic
    $lessons = get_posts([
        'post_type' => 'lesson',
        'post_parent' => $topic_id,
        'fields' => 'ids',
        'orderby' => 'menu_order',
        'order' => 'ASC'
    ]);

    $is_last_lesson = end($lessons) == $lesson_id;

    if ($is_last_lesson && $topic_id) {
        $completed = get_user_meta($user_id, '_tpt_completed_topics', true) ?: [];
        if (!in_array($topic_id, $completed)) {
            $completed[] = $topic_id;
            update_user_meta($user_id, '_tpt_completed_topics', array_unique($completed));
        }
    }
}, 10, 2);